name: Make Docker image

on:
  workflow_dispatch: ~
  workflow_run:
    workflows: ["Unit Test & Functional Test & E2E Test"]
    types:
      - completed

jobs:
  make-docker:
    name: build-and-push-image
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}

    steps:
      - name: checkout
        id: checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.sha }}

      - name: build-image
        id: build-image
        run: docker build -t aboubakr67/cashing_machine_with_action:latest .

      - name: push-image
        id: push-image
        run: |
          docker login -u aboubakr67 -p ${{ secrets.DOCKER_HUB_TOKEN }}
          docker push aboubakr67/cashing_machine_with_action:latest

      - name: add-summary
        if: success()
        run: |
          echo "🐳 Docker image pushed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull:** \`docker pull aboubakr67/cashing_machine_with_action:latest\`" >> $GITHUB_STEP_SUMMARY

      - name: build-failure-summary
        if: failure() && steps.build-image.outcome == 'failure'
        run: |
          echo "❌ Docker build failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY

      - name: push-failure-summary
        if: failure() && steps.push-image.outcome == 'failure'
        run: |
          echo "❌ Docker push failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Possible causes:" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid Docker Hub credentials" >> $GITHUB_STEP_SUMMARY
          echo "- Network issues" >> $GITHUB_STEP_SUMMARY
          echo "- Repository doesn't exist or no push permission" >> $GITHUB_STEP_SUMMARY
