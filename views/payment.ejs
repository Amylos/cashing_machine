<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Payment Page</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
  </head>
  <style>
    .coins {
      max-width: 200px;
    }
    * {
      font-family: Arial, sans-serif;
      font-size: 1.1rem;
    }
  </style>
  <body class="p-5">
    <div class="container">
      <h1>Payment</h1>
      <form id="paymentForm" method="POST">
        <div class="mb-3">
          <label for="amount" class="form-label"
            >Product's Total Amount (€)</label
          >
          <input
            type="number"
            step="0.01"
            class="form-control"
            id="amount"
            name="amount"
            style="max-width: 350px"
            placeholder="Enter total amount"
            required
          />
        </div>

        <div class="mb-3 form-check">
          <input
            type="checkbox"
            class="form-check-input"
            id="bigBills"
            name="bigBills"
          />
          <label class="form-check-label" for="bigBills"
            >I want big bills</label
          >
        </div>

        <h5>Coins / Bills</h5>

        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">0.01€</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[0.01]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">0.02€</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[0.02]"
                value="0"
              />
            </div>
            <div class="mb-1">
              <label class="form-label">0.10€</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[0.10]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">0.20€</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[0.20]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">0.50€</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[0.50]"
                value="0"
              />
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">1 €</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[1]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">2 €</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[2]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">5 €</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[5]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">10 €</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[10]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">20 €</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[20]"
                value="0"
              />
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label class="form-label">50 €</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[50]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">100 €</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[100]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">200 €</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[200]"
                value="0"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">500 €</label>
              <input
                type="number"
                min="0"
                class="form-control form-control-sm coins"
                name="exchange[500]"
                value="0"
              />
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Pay</button>
      </form>
    </div>

    <script>
      const form = document.getElementById("paymentForm");
      const bigBillsCheckbox = document.getElementById("bigBills");

      function handlePayment(data) {
        console.info("Data : ", data);

        if (
          data.amount >
          Object.keys(data.exchange).reduce(
            (sum, key) => sum + key * data.exchange[key],
            0
          )
        ) {
          alert("Insufficient payment amount.");
          return;
        }

        fetch("/api/payment", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((res) => res.json())
          .then((result) => {
            if (result.success) {
              const query = encodeURIComponent(
                JSON.stringify(result.changeToGive)
              );
              window.location.href = `/change?data=${query}`;
            } else {
              alert(result.message);
            }
          })
          .catch((err) => console.error(err));
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const data = Object.fromEntries(new FormData(form).entries());

        data.amount = Number(data.amount);
        data.bigBills = bigBillsCheckbox.checked;

        const exchange = {};
        for (const key in data) {
          if (key.startsWith("exchange[")) {
            const exchangeCoin = key.match(/exchange\[(.+)\]/)[1];
            exchange[exchangeCoin] = Number(data[key]);
            delete data[key];
          }
        }
        data.exchange = exchange;

        handlePayment(data);
      });
    </script>
  </body>
</html>
